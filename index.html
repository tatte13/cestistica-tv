<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cestistica TV - Club Channel Biancoverde</title>
    <meta name="description" content="Il club channel ufficiale della Cestistica Savonese">
    <meta name="theme-color" content="#228B22">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://i.imgur.com/WbvsajN.png">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * { font-family: 'Poppins', sans-serif; }
        :root { --forest-green: #228B22; --light-forest: #3CB371; --dark-green: #1a6b1a; }
        .gradient-bg { background: linear-gradient(135deg, #228B22 0%, #1a6b1a 100%); }
        .card-hover:hover { transform: scale(1.02); transition: all 0.3s ease; }
        .video-card { transition: all 0.3s ease; }
        .video-card:hover { box-shadow: 0 0 20px rgba(34, 139, 34, 0.5); }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1a1a1a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #228B22; border-radius: 4px; }
        .hero-gradient { background: linear-gradient(to top, #111 0%, transparent 60%); }
        input:focus, textarea:focus, select:focus { outline: none; box-shadow: 0 0 0 2px #3CB371; }
        .animate-pulse-slow { animation: pulse 3s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .mobile-menu { transform: translateX(-100%); transition: transform 0.3s ease; }
        .mobile-menu.open { transform: translateX(0); }
        .loading-overlay { position: fixed; inset: 0; background: #111; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: #228B22; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .sync-indicator { position: fixed; bottom: 20px; left: 20px; padding: 8px 16px; border-radius: 20px; font-size: 12px; z-index: 50; }
        .sync-indicator.online { background: #22c55e; color: white; }
        .sync-indicator.offline { background: #ef4444; color: white; }
        #heroBackground { transition: opacity 0.5s ease, background-image 0.5s ease; }
        .tab-btn { padding: 10px 20px; border-radius: 8px; transition: all 0.3s; }
        .tab-btn.active { background: #228B22; color: white; }
        .tab-btn:not(.active) { background: #374151; color: #9ca3af; }
        .tab-btn:not(.active):hover { background: #4b5563; }
        @media (max-width: 768px) {
            .video-card { min-width: 160px !important; }
            .video-card img { height: 100px !important; }
            .video-card .p-4 { padding: 0.75rem !important; }
            .video-card h4 { font-size: 0.875rem !important; }
            .hero-text { font-size: 1.75rem !important; }
            .hero-desc { font-size: 0.875rem !important; }
            .category-title { font-size: 1.25rem !important; }
        }
        .biancoverdi-card {
            background: linear-gradient(135deg, #1a6b1a 0%, #228B22 50%, #3CB371 100%);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        .biancoverdi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        .qr-code { image-rendering: pixelated; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Install PWA Banner -->
    <div id="installBanner" class="fixed bottom-20 left-4 right-4 md:left-auto md:right-4 md:w-80 bg-green-700 p-4 rounded-xl shadow-2xl z-50 hidden">
        <div class="flex items-center justify-between">
            <div>
                <p class="font-bold">ğŸ“² Installa Cestistica TV</p>
                <p class="text-sm text-green-200">Aggiungi alla home</p>
            </div>
            <div class="flex gap-2">
                <button onclick="installPWA()" class="bg-white text-green-700 px-4 py-2 rounded-lg font-bold text-sm">Installa</button>
                <button onclick="dismissInstall()" class="text-green-200 hover:text-white">âœ•</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black/90 flex items-center justify-center hidden" style="z-index: 10001;">
        <div class="bg-gray-800 p-6 md:p-8 rounded-2xl max-w-md w-full mx-4 border border-green-600/30">
            <div class="text-center mb-6">
                <img id="authLogo" src="" alt="Cestistica TV" class="h-16 mx-auto mb-4 hidden">
                <div id="authLogoPlaceholder" class="text-5xl mb-2">ğŸ€</div>
                <h1 class="text-2xl md:text-3xl font-bold text-white">Cestistica TV</h1>
                <p class="text-green-400 font-medium mt-1">cestistica tv+</p>
            </div>
            
            <div id="loginForm">
                <h2 class="text-xl font-semibold mb-4 text-center">Accedi</h2>
                <input type="text" id="loginUsername" placeholder="Username" class="w-full p-3 rounded-lg bg-gray-700 mb-3 border border-gray-600">
                <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-700 mb-4 border border-gray-600">
                <button onclick="login()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">Accedi</button>
                <p class="text-center mt-4 text-gray-400 text-sm">Non hai un account? <span onclick="showRegister()" class="text-green-400 cursor-pointer hover:underline">Registrati gratis</span></p>
            </div>
            
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Registrati a cestistica tv+</h2>
                <p class="text-center text-green-400 text-sm mb-4">âœ“ 100% Gratuito per sempre</p>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="text" id="regNome" placeholder="Nome" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600">
                    <input type="text" id="regCognome" placeholder="Cognome" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600">
                </div>
                <input type="text" id="regUsername" placeholder="Username" class="w-full p-3 rounded-lg bg-gray-700 mb-3 border border-gray-600">
                <input type="email" id="regEmail" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-700 mb-3 border border-gray-600">
                <input type="password" id="regPassword" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-700 mb-4 border border-gray-600">
                <button onclick="register()" class="w-full gradient-bg text-white py-3 rounded-lg font-semibold hover:opacity-90 transition">Iscriviti Gratis</button>
                <p class="text-center mt-4 text-gray-400 text-sm">Hai giÃ  un account? <span onclick="showLogin()" class="text-green-400 cursor-pointer hover:underline">Accedi</span></p>
            </div>
            <p id="authError" class="text-red-400 text-center mt-3 text-sm hidden"></p>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenuOverlay" class="fixed inset-0 bg-black/70 z-40 hidden" onclick="closeMobileMenu()"></div>
    <div id="mobileMenu" class="mobile-menu fixed top-0 left-0 h-full w-72 bg-gray-800 z-50 p-6 overflow-y-auto">
        <div class="flex items-center justify-between mb-8">
            <span class="text-xl font-bold text-green-400">Menu</span>
            <button onclick="closeMobileMenu()" class="text-gray-400 hover:text-white text-2xl">âœ•</button>
        </div>
        <nav class="space-y-2">
            <button onclick="showHome(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ  Home</button>
            <button onclick="showNews(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ“° News</button>
            <button onclick="showCalendar(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ“… Calendario</button>
            <button onclick="showPronostici(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ¯ Pronostici</button>
            <button onclick="showClassifica(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ† Classifica</button>
            <button onclick="showSocialWall(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ“¸ Social</button>
            <button onclick="showWatchlist(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">â¤ï¸ La Mia Lista</button>
            <hr class="border-gray-700 my-4">
            <button onclick="showUserDetails(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ‘¤ Profilo</button>
            <button onclick="showBiancoverdiCard(); closeMobileMenu();" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3">ğŸ« Biancoverdi Card</button>
            <button onclick="showAdmin(); closeMobileMenu();" id="mobileAdminBtn" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 hidden">âš™ï¸ Admin</button>
            <button onclick="logout()" class="w-full text-left py-3 px-4 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 text-red-400">ğŸšª Esci</button>
        </nav>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 p-6 rounded-2xl max-w-md w-full border border-green-600/30 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">ğŸ‘¤ Profilo</h3>
                <button onclick="closeUserDetails()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="flex flex-col items-center mb-6">
                <div class="relative group">
                    <div id="userAvatar" class="w-24 h-24 bg-green-600 rounded-full flex items-center justify-center text-3xl font-bold overflow-hidden">
                        <img id="userAvatarImg" src="" class="w-full h-full object-cover hidden">
                        <span id="userAvatarInitial"></span>
                    </div>
                    <label class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer">
                        ğŸ“·<input type="file" id="profilePhotoInput" accept="image/*" onchange="uploadProfilePhoto(event)" class="hidden">
                    </label>
                </div>
                <button onclick="document.getElementById('profilePhotoInput').click()" class="mt-3 text-sm text-green-400 hover:underline">ğŸ“· Cambia Foto</button>
                <button onclick="removeProfilePhoto()" id="removePhotoBtn" class="mt-1 text-sm text-red-400 hover:underline hidden">ğŸ—‘ï¸ Rimuovi</button>
                <p id="userFullName" class="font-semibold text-lg mt-3"></p>
                <p class="text-green-400 text-sm">cestistica tv+ Member</p>
            </div>
            <div class="bg-gray-700 rounded-lg p-4 space-y-3">
                <div class="flex justify-between"><span class="text-gray-400">Username:</span><span id="userUsername" class="font-medium"></span></div>
                <div class="flex justify-between"><span class="text-gray-400">Email:</span><span id="userEmail" class="font-medium"></span></div>
                <div class="flex justify-between"><span class="text-gray-400">Membro dal:</span><span id="userDate" class="font-medium"></span></div>
                <div class="flex justify-between"><span class="text-gray-400">Biancoverdi Points:</span><span id="userPoints" class="font-medium text-green-400">0 ğŸ’š</span></div>
                <div class="flex justify-between"><span class="text-gray-400">Badge:</span><span id="userBadge" class="font-medium"></span></div>
            </div>
            <button onclick="closeUserDetails()" class="w-full mt-6 bg-gray-600 py-3 rounded-lg font-semibold hover:bg-gray-500 transition">Chiudi</button>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 p-6 rounded-2xl max-w-sm w-full border border-green-600/30">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">ğŸ“¤ Condividi</h3>
                <button onclick="closeShareModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="shareWhatsApp()" class="flex items-center justify-center gap-2 bg-green-600 p-4 rounded-xl hover:bg-green-700 transition">
                    <span class="text-2xl">ğŸ“±</span> WhatsApp
                </button>
                <button onclick="shareFacebook()" class="flex items-center justify-center gap-2 bg-blue-600 p-4 rounded-xl hover:bg-blue-700 transition">
                    <span class="text-2xl">ğŸ“˜</span> Facebook
                </button>
                <button onclick="shareTwitter()" class="flex items-center justify-center gap-2 bg-sky-500 p-4 rounded-xl hover:bg-sky-600 transition">
                    <span class="text-2xl">ğŸ¦</span> Twitter
                </button>
                <button onclick="copyLink()" class="flex items-center justify-center gap-2 bg-gray-600 p-4 rounded-xl hover:bg-gray-700 transition">
                    <span class="text-2xl">ğŸ”—</span> Copia Link
                </button>
            </div>
        </div>
    </div>

    <!-- Points Info Modal -->
    <div id="pointsInfoModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-800 p-6 rounded-2xl max-w-md w-full border border-green-600/30 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">ğŸ’š Biancoverdi Points</h3>
                <button onclick="closePointsInfo()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="mb-6">
                <h4 class="font-semibold mb-3 text-green-400">â­ Come Guadagnare Punti:</h4>
                <div class="bg-gray-700 rounded-lg p-4 space-y-2 text-sm">
                    <div class="flex justify-between"><span>ğŸ¬ Guarda un video</span><span class="text-green-400">+5</span></div>
                    <div class="flex justify-between"><span>ğŸ’¬ Scrivi un commento</span><span class="text-green-400">+10</span></div>
                    <div class="flex justify-between"><span>ğŸ‘ Metti like</span><span class="text-green-400">+2</span></div>
                    <div class="flex justify-between"><span>ğŸ“ Chat live</span><span class="text-green-400">+2</span></div>
                    <div class="flex justify-between"><span>ğŸ¯ Vota un pronostico</span><span class="text-green-400">+5</span></div>
                    <div class="flex justify-between"><span>âœ… Pronostico corretto</span><span class="text-green-400">+50</span></div>
                    <div class="flex justify-between"><span>ğŸ” Login giornaliero</span><span class="text-green-400">+3</span></div>
                </div>
            </div>
            <div>
                <h4 class="font-semibold mb-3 text-green-400">ğŸ… Badge Sbloccabili:</h4>
                <div class="bg-gray-700 rounded-lg p-4 space-y-2 text-sm">
                    <div class="flex justify-between"><span>ğŸŒ± Nuovo Arrivato</span><span>0 punti</span></div>
                    <div class="flex justify-between"><span>ğŸ‘€ Spettatore</span><span>50 punti</span></div>
                    <div class="flex justify-between"><span>ğŸ€ Tifoso</span><span>150 punti</span></div>
                    <div class="flex justify-between"><span>ğŸ”¥ Super Tifoso</span><span>300 punti</span></div>
                    <div class="flex justify-between"><span>ğŸ’š Ultras</span><span>500 punti</span></div>
                    <div class="flex justify-between"><span>ğŸ‘‘ Leggenda</span><span>1000 punti</span></div>
                </div>
            </div>
            <button onclick="closePointsInfo()" class="w-full mt-6 gradient-bg py-3 rounded-lg font-semibold">Ho Capito!</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div id="syncIndicator" class="sync-indicator online">
            <span class="w-2 h-2 bg-white rounded-full inline-block mr-2"></span>
            <span id="syncText">Sincronizzato</span>
        </div>

        <!-- Header -->
        <header class="fixed top-0 left-0 right-0 z-40 bg-gradient-to-b from-black/95 to-transparent">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="openMobileMenu()" class="md:hidden p-2 hover:bg-gray-700 rounded-lg text-xl">â˜°</button>
                    <div class="flex items-center gap-2 cursor-pointer" onclick="showHome()">
                        <img id="headerLogo" src="" class="h-10 md:h-12 hidden">
                        <span id="headerLogoEmoji" class="text-3xl">ğŸ€</span>
                    </div>
                </div>
                
                <nav class="hidden md:flex items-center gap-6">
                    <button onclick="showHome()" class="hover:text-green-400 transition">Home</button>
                    <button onclick="showNews()" class="hover:text-green-400 transition">News</button>
                    <button onclick="showCalendar()" class="hover:text-green-400 transition">Calendario</button>
                    <button onclick="showPronostici()" class="hover:text-green-400 transition">Pronostici</button>
                    <button onclick="showClassifica()" class="hover:text-green-400 transition">Classifica</button>
                    <button onclick="showSocialWall()" class="hover:text-green-400 transition">Social</button>
                    <button onclick="showWatchlist()" class="hover:text-green-400 transition">La Mia Lista</button>
                </nav>
                
                <div class="flex items-center gap-2 md:gap-4">
                    <div class="relative hidden md:block">
                        <input type="text" id="searchInput" placeholder="Cerca..." class="bg-gray-800 pl-10 pr-4 py-2 rounded-full text-sm w-40 border border-gray-700" onkeyup="searchVideos()">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="relative group">
                        <button class="flex items-center gap-2 bg-green-600 px-3 py-2 rounded-full text-sm">
                            <div id="headerUserPhoto" class="w-6 h-6 rounded-full bg-green-700 flex items-center justify-center overflow-hidden">
                                <span id="headerUserInitial" class="text-xs font-bold"></span>
                            </div>
                            <span id="currentUser" class="font-medium hidden md:inline"></span>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl hidden group-hover:block border border-gray-700">
                            <button onclick="showUserDetails()" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-t-lg">ğŸ‘¤ Profilo</button>
                            <button onclick="showBiancoverdiCard()" class="w-full text-left px-4 py-3 hover:bg-gray-700">ğŸ« Biancoverdi Card</button>
                            <button onclick="showAdmin()" id="adminBtn" class="w-full text-left px-4 py-3 hover:bg-gray-700 hidden">âš™ï¸ Admin</button>
                            <button onclick="logout()" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-b-lg text-red-400">ğŸšª Esci</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Home Content -->
        <main id="homeContent" class="pt-16">
            <div id="heroSection" class="relative h-[50vh] md:h-[70vh] overflow-hidden">
                <div id="heroBackground" class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1546519638-68e109498ffc?w=1600');"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-black/90 via-black/60 to-transparent"></div>
                <div class="hero-gradient absolute inset-0"></div>
                
                <div class="absolute bottom-16 left-4 md:left-8 right-4 max-w-2xl">
                    <span id="heroBadge" class="bg-green-600 px-3 py-1 rounded-full text-sm font-medium mb-4 inline-block">ğŸ€ Cestistica</span>
                    <h2 id="heroTitle" class="hero-text text-3xl md:text-5xl font-bold mb-4">Benvenuto su Cestistica TV</h2>
                    <p id="heroDesc" class="hero-desc text-sm md:text-lg text-gray-300 mb-6"></p>
                    <div class="flex gap-3 flex-wrap">
                        <button id="heroPlayBtn" onclick="playHeroVideo()" class="gradient-bg px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:opacity-90 transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            Guarda Ora
                        </button>
                        <button onclick="addHeroToWatchlist()" class="bg-gray-700/80 px-6 py-3 rounded-lg font-semibold flex items-center gap-2 hover:bg-gray-600 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            La Mia Lista
                        </button>
                    </div>
                </div>
                
                <div id="carouselIndicators" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2"></div>
                <button onclick="prevHeroSlide()" class="absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 p-3 rounded-full transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button onclick="nextHeroSlide()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 hover:bg-black/70 p-3 rounded-full transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <div class="px-4 md:px-8 mt-8 pb-20">
                <section id="liveSection" class="mb-12">
                    <h3 class="category-title text-xl md:text-2xl font-bold mb-4 flex items-center gap-2"><span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span> Live</h3>
                    <div id="liveVideos" class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar"></div>
                </section>

                <section id="replaysSection" class="mb-12">
                    <h3 class="category-title text-xl md:text-2xl font-bold mb-4">ğŸ¬ Full Match Replays</h3>
                    <div id="replaysVideos" class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar"></div>
                </section>

                <section id="highlightsSection" class="mb-12">
                    <h3 class="category-title text-xl md:text-2xl font-bold mb-4">âš¡ Highlights</h3>
                    <div id="highlightsVideos" class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar"></div>
                </section>

                <section id="altroSection" class="mb-12">
                    <h3 class="category-title text-xl md:text-2xl font-bold mb-4">ğŸ“º Altro</h3>
                    <div id="altroVideos" class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar"></div>
                </section>

                <!-- Sponsor Section -->
                <section id="sponsorSection" class="mb-12 mt-16">
                    <h3 class="text-xl md:text-2xl font-bold mb-6 text-center">ğŸ¤ I Nostri Partner</h3>
                    <div id="sponsorList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto"></div>
                    <p id="noSponsors" class="text-gray-500 text-center py-8 hidden">Nessun partner</p>
                </section>
            </div>
        </main>

        <!-- Video Page -->
        <div id="videoPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <button onclick="showHome()" class="mb-4 flex items-center gap-2 text-green-400 hover:underline">â† Torna alla Home</button>
                
                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <div class="aspect-video bg-black rounded-xl overflow-hidden shadow-2xl">
                            <iframe id="videoPlayer" src="" class="w-full h-full" style="border:none;" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"></iframe>
                        </div>
                        
                        <div class="mt-6">
                            <h2 id="videoTitle" class="text-xl md:text-2xl font-bold"></h2>
                            <div class="flex flex-wrap items-center gap-4 mt-2 text-sm text-gray-400">
                                <span id="videoCategory"></span>
                                <span id="videoDate"></span>
                                <span id="videoViews">0 visualizzazioni</span>
                            </div>
                            
                            <div class="flex gap-4 mt-4">
                                <button onclick="toggleLike()" id="likeBtn" class="flex items-center gap-2 bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                                    <svg id="likeIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                    <span id="likeCount">0</span>
                                </button>
                                <button onclick="openShareModal()" class="flex items-center gap-2 bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-600 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                                    Condividi
                                </button>
                            </div>
                            
                            <p id="videoDescription" class="text-gray-300 mt-4"></p>
                        </div>

                        <!-- Live Chat (solo per Live) -->
                        <div id="liveChatSection" class="hidden mt-6 bg-gray-800 rounded-xl p-4">
                            <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> Chat Live</h3>
                            <div id="liveChatMessages" class="h-48 overflow-y-auto mb-4 space-y-2 bg-gray-900 rounded-lg p-3"></div>
                            <div class="flex gap-2">
                                <input type="text" id="liveChatInput" placeholder="Scrivi un messaggio..." class="flex-1 bg-gray-700 px-4 py-2 rounded-lg text-sm border border-gray-600" onkeypress="if(event.key==='Enter')sendLiveChat()">
                                <button onclick="sendLiveChat()" class="gradient-bg px-4 py-2 rounded-lg font-semibold">Invia</button>
                            </div>
                        </div>

                        <!-- Comments Section -->
                        <div class="mt-8 bg-gray-800 rounded-xl p-4 md:p-6">
                            <h3 class="text-lg md:text-xl font-bold mb-4">ğŸ’¬ Commenti</h3>
                            <div class="flex gap-2 md:gap-4 mb-6">
                                <input type="text" id="commentInput" placeholder="Scrivi un commento..." class="flex-1 bg-gray-700 px-3 md:px-4 py-2 md:py-3 rounded-lg text-sm border border-gray-600" onkeypress="if(event.key==='Enter')addComment()">
                                <button onclick="addComment()" class="gradient-bg px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold text-sm">Invia</button>
                            </div>
                            <div id="commentsList" class="space-y-4"></div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg md:text-xl font-bold mb-4">Video Correlati</h3>
                        <div id="relatedVideos" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Page -->
        <div id="newsPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">ğŸ“° News</h2>
                <div id="newsList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <p id="emptyNews" class="text-gray-400 text-center py-20 hidden">Nessuna news disponibile</p>
            </div>
        </div>

        <!-- News Article Page -->
        <div id="newsArticlePage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4 max-w-4xl">
                <button onclick="showNews()" class="mb-4 flex items-center gap-2 text-green-400 hover:underline">â† Torna alle News</button>
                <article id="articleContent"></article>
            </div>
        </div>

        <!-- Calendar Page -->
        <div id="calendarPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">ğŸ“… Calendario Partite</h2>
                <div id="calendarContent" class="bg-gray-800 rounded-xl p-6">
                    <p id="noCalendar" class="text-gray-400 text-center py-10">Nessun calendario caricato</p>
                    <div id="calendarPdfViewer" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <button onclick="prevPdfPage()" class="bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-600">â† Precedente</button>
                            <span id="pdfPageInfo">Pagina 1 di 1</span>
                            <button onclick="nextPdfPage()" class="bg-gray-700 px-4 py-2 rounded-lg hover:bg-gray-600">Successiva â†’</button>
                        </div>
                        <canvas id="pdfCanvas" class="w-full bg-white rounded-lg"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pronostici Page -->
        <div id="pronosticiPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">ğŸ¯ Pronostici</h2>
                <div id="pronosticiList" class="space-y-4"></div>
                <p id="emptyPronostici" class="text-gray-400 text-center py-20 hidden">Nessun pronostico attivo</p>
            </div>
        </div>

        <!-- Classifica Page -->
        <div id="classificaPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl md:text-3xl font-bold">ğŸ† Classifica Tifosi</h2>
                    <button onclick="showPointsInfo()" class="w-10 h-10 rounded-full bg-gray-700 hover:bg-gray-600 flex items-center justify-center transition" title="Come funzionano i punti?">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                </div>
                <div id="classificaList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Social Wall Page -->
        <div id="socialWallPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">ğŸ“¸ Social Wall</h2>
                
                <!-- Instagram Profile Card -->
                <div class="bg-gradient-to-r from-purple-600 via-pink-500 to-orange-400 rounded-2xl p-1 mb-8">
                    <div class="bg-gray-900 rounded-xl p-6">
                        <div class="flex flex-col md:flex-row items-center gap-6">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-r from-purple-500 via-pink-500 to-orange-400 p-1">
                                <img src="https://unavatar.io/instagram/cestisticasavonese" alt="Cestistica Savonese" class="w-full h-full rounded-full object-cover bg-gray-800" onerror="this.src='https://via.placeholder.com/96?text=ğŸ€'">
                            </div>
                            <div class="text-center md:text-left flex-1">
                                <h3 class="text-xl font-bold flex items-center justify-center md:justify-start gap-2">
                                    @cestisticasavonese
                                    <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                </h3>
                                <p class="text-gray-400 mt-1">Profilo ufficiale Instagram della Cestistica Savonese ğŸ€ğŸ’š</p>
                                <a href="https://instagram.com/cestisticasavonese" target="_blank" class="inline-flex items-center gap-2 mt-4 bg-gradient-to-r from-purple-600 via-pink-500 to-orange-400 px-6 py-2 rounded-lg font-semibold hover:opacity-90 transition">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                                    Seguici su Instagram
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instagram Feed Embed -->
                <div class="bg-gray-800 rounded-xl p-6">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-pink-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                        Ultimi Post
                    </h3>
                    
                    <!-- Widget Container -->
                    <div id="instagramWidget" class="min-h-[400px]">
                        <!-- Elfsight Widget - Replace with your widget code -->
                        <script src="https://static.elfsight.com/platform/platform.js" async></script>
                        <div class="elfsight-app-b5c8f8e8-xxxx-xxxx-xxxx-xxxxxxxxxxxx" data-elfsight-app-lazy></div>
                        
                        <!-- Fallback content -->
                        <div id="instagramFallback" class="text-center py-10">
                            <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-r from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073z"/></svg>
                            </div>
                            <p class="text-gray-400 mb-4">Visualizza i nostri ultimi post su Instagram</p>
                            <a href="https://instagram.com/cestisticasavonese" target="_blank" class="inline-flex items-center gap-2 bg-gradient-to-r from-purple-600 via-pink-500 to-orange-400 px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069z"/></svg>
                                Apri Instagram
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
                    <a href="https://instagram.com/cestisticasavonese" target="_blank" class="bg-gradient-to-br from-purple-600 to-pink-500 rounded-xl p-4 text-center hover:scale-105 transition">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069z"/></svg>
                        <span class="font-semibold">Instagram</span>
                    </a>
                    <a href="https://facebook.com/cestisticasavonese" target="_blank" class="bg-blue-600 rounded-xl p-4 text-center hover:scale-105 transition">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        <span class="font-semibold">Facebook</span>
                    </a>
                    <a href="https://twitter.com/cestisticasv" target="_blank" class="bg-sky-500 rounded-xl p-4 text-center hover:scale-105 transition">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        <span class="font-semibold">X / Twitter</span>
                    </a>
                    <a href="https://youtube.com/@cestisticasavonese" target="_blank" class="bg-red-600 rounded-xl p-4 text-center hover:scale-105 transition">
                        <svg class="w-8 h-8 mx-auto mb-2" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                        <span class="font-semibold">YouTube</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Watchlist Page -->
        <div id="watchlistPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">â¤ï¸ La Mia Lista</h2>
                <div id="watchlistVideos" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
                <p id="emptyWatchlist" class="text-gray-400 text-center py-20 hidden">La tua lista Ã¨ vuota</p>
            </div>
        </div>

        <!-- Biancoverdi Card Page -->
        <div id="biancoverdiCardPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4 max-w-md">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center">ğŸ« Biancoverdi Card</h2>
                
                <div id="cardContainer" class="biancoverdi-card mb-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <img id="cardLogo" src="" class="h-10 hidden">
                            <span id="cardLogoEmoji" class="text-3xl">ğŸ€</span>
                        </div>
                        <span class="text-sm font-bold opacity-80">CESTISTICA TV+</span>
                    </div>
                    
                    <div class="flex items-center gap-4 mb-4">
                        <div id="cardAvatar" class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold overflow-hidden">
                            <img id="cardAvatarImg" src="" class="w-full h-full object-cover hidden">
                            <span id="cardAvatarInitial" class="text-white"></span>
                        </div>
                        <div>
                            <p id="cardFullName" class="font-bold text-lg"></p>
                            <p id="cardUsername" class="text-green-200 text-sm"></p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end">
                        <div>
                            <p class="text-xs opacity-70">TESSERA NÂ°</p>
                            <p id="cardNumber" class="font-mono font-bold"></p>
                            <p id="cardBadge" class="text-sm mt-1"></p>
                        </div>
                        <div id="qrCode" class="w-20 h-20 bg-white rounded-lg p-1">
                            <canvas id="qrCanvas" class="w-full h-full qr-code"></canvas>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-white/20 flex justify-between text-xs opacity-70">
                        <span>MEMBRO DAL</span>
                        <span id="cardDate"></span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button onclick="downloadCard()" class="w-full bg-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-600 transition flex items-center justify-center gap-2">
                        ğŸ“¥ Scarica Card
                    </button>
                    <button onclick="addToGoogleWallet()" class="w-full bg-white text-gray-900 py-3 rounded-lg font-semibold hover:bg-gray-200 transition flex items-center justify-center gap-2">
                        <img src="https://www.gstatic.com/instantbuy/svg/dark_gpay.svg" class="h-6" alt="Google Pay">
                        Aggiungi a Google Wallet
                    </button>
                    <button onclick="addToAppleWallet()" class="w-full bg-black py-3 rounded-lg font-semibold hover:bg-gray-900 transition flex items-center justify-center gap-2 border border-gray-700">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
                        Aggiungi a Apple Wallet
                    </button>
                </div>
                
                <p class="text-center text-gray-500 text-xs mt-4">La tua tessera digitale del mondo biancoverde</p>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="adminPage" class="hidden pt-20 pb-20">
            <div class="container mx-auto px-4">
                <h2 class="text-2xl md:text-3xl font-bold mb-6">âš™ï¸ Pannello Admin</h2>
                
                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-green-400" id="statVideos">0</p>
                        <p class="text-gray-400 text-sm">Video</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-blue-400" id="statUsers">0</p>
                        <p class="text-gray-400 text-sm">Utenti</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-yellow-400" id="statViews">0</p>
                        <p class="text-gray-400 text-sm">Visualizzazioni</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 text-center">
                        <p class="text-3xl font-bold text-purple-400" id="statNews">0</p>
                        <p class="text-gray-400 text-sm">News</p>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <button onclick="showAdminTab('video')" class="tab-btn active" id="tabVideo">ğŸ“¹ Video</button>
                    <button onclick="showAdminTab('news')" class="tab-btn" id="tabNews">ğŸ“° News</button>
                    <button onclick="showAdminTab('calendar')" class="tab-btn" id="tabCalendar">ğŸ“… Calendario</button>
                    <button onclick="showAdminTab('pronostici')" class="tab-btn" id="tabPronostici">ğŸ¯ Pronostici</button>
                    <button onclick="showAdminTab('users')" class="tab-btn" id="tabUsers">ğŸ‘¥ Utenti</button>
                    <button onclick="showAdminTab('logo')" class="tab-btn" id="tabLogo">ğŸ–¼ï¸ Logo</button>
                    <button onclick="showAdminTab('sponsor')" class="tab-btn" id="tabSponsor">ğŸ¤ Sponsor</button>
                </div>

                <!-- Video Tab -->
                <div id="adminVideoTab" class="space-y-6">
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4">â• Aggiungi Video</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <input type="text" id="newVideoTitle" placeholder="Titolo video" class="bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            <input type="text" id="newVideoUrl" placeholder="URL YouTube (video o live)" class="bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            <select id="newVideoCategory" class="bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                                <option value="live">ğŸ”´ Live</option>
                                <option value="replays">ğŸ¬ Full Match Replays</option>
                                <option value="highlights">âš¡ Highlights</option>
                                <option value="altro">ğŸ“º Altro</option>
                            </select>
                            <input type="text" id="newVideoThumbnail" placeholder="URL Thumbnail (opzionale)" class="bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                        </div>
                        <textarea id="newVideoDesc" placeholder="Descrizione" class="w-full bg-gray-700 px-4 py-3 rounded-lg mt-4 border border-gray-600 h-20"></textarea>
                        <button onclick="addVideo()" class="mt-4 gradient-bg px-6 py-3 rounded-lg font-semibold">Aggiungi Video</button>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4">ğŸ“¹ Gestione Video</h3>
                        <div id="adminVideoList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- News Tab -->
                <div id="adminNewsTab" class="space-y-6 hidden">
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4" id="newsFormTitle">â• Nuova News</h3>
                        <input type="hidden" id="editNewsId">
                        <input type="text" id="newNewsTitle" placeholder="Titolo articolo" class="w-full bg-gray-700 px-4 py-3 rounded-lg mb-3 border border-gray-600">
                        <textarea id="newNewsContent" placeholder="Contenuto articolo..." class="w-full bg-gray-700 px-4 py-3 rounded-lg mb-3 border border-gray-600 h-32"></textarea>
                        
                        <div class="mb-3">
                            <label class="block text-sm text-gray-400 mb-2">ğŸ“· Carica Immagini (max 5)</label>
                            <input type="file" id="newsImagesInput" accept="image/*" multiple class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            <div id="newsImagesPreview" class="flex gap-2 mt-2 flex-wrap"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm text-gray-400 mb-2">ğŸ¬ Video (scegli un'opzione)</label>
                            <input type="text" id="newNewsVideo" placeholder="URL video YouTube" class="w-full bg-gray-700 px-4 py-3 rounded-lg mb-2 border border-gray-600">
                            <p class="text-xs text-gray-500 mb-2 text-center">â€” oppure â€”</p>
                            <input type="file" id="newsVideoInput" accept="video/*" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            <p class="text-xs text-gray-500 mt-1">âš ï¸ Upload diretto: max 10MB (per video piÃ¹ lunghi usa YouTube)</p>
                            <div id="newsVideoPreview" class="mt-2 hidden">
                                <video id="newsVideoPreviewPlayer" class="w-full max-h-40 rounded-lg" controls></video>
                                <button onclick="removeNewsVideo()" class="text-red-400 text-sm mt-1 hover:underline">ğŸ—‘ï¸ Rimuovi video</button>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="addNews()" id="newsSubmitBtn" class="gradient-bg px-6 py-3 rounded-lg font-semibold">Pubblica News</button>
                            <button onclick="cancelNewsEdit()" id="newsCancelBtn" class="bg-gray-600 px-6 py-3 rounded-lg font-semibold hidden">Annulla</button>
                        </div>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4">ğŸ“° Gestione News</h3>
                        <div id="adminNewsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="adminCalendarTab" class="hidden">
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4">ğŸ“… Carica Calendario PDF</h3>
                        <div class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center">
                            <p class="text-gray-400 mb-4">Carica un file PDF con il calendario delle partite</p>
                            <label class="gradient-bg px-6 py-3 rounded-lg cursor-pointer hover:opacity-90 inline-block">
                                ğŸ“¤ Seleziona PDF
                                <input type="file" accept=".pdf" onchange="uploadCalendarPdf(event)" class="hidden">
                            </label>
                        </div>
                        <div id="currentCalendarInfo" class="mt-4 hidden">
                            <p class="text-green-400">âœ… Calendario caricato</p>
                            <button onclick="removeCalendar()" class="mt-2 text-red-400 hover:underline">ğŸ—‘ï¸ Rimuovi calendario</button>
                        </div>
                    </div>
                </div>

                <!-- Pronostici Tab -->
                <div id="adminPronosticiTab" class="space-y-6 hidden">
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4" id="pronoFormTitle">â• Nuovo Pronostico</h3>
                        <input type="hidden" id="editPronoId">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Squadra Casa</label>
                                <input type="text" id="newPronoTeam1" placeholder="Es. Cestistica Savonese" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Squadra Ospite</label>
                                <input type="text" id="newPronoTeam2" placeholder="Es. Basket Albenga" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Data Partita</label>
                                <input type="date" id="newPronoDate" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Ora Partita</label>
                                <input type="time" id="newPronoTime" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button onclick="addPronostico()" id="pronoSubmitBtn" class="gradient-bg px-6 py-3 rounded-lg font-semibold">Crea Pronostico</button>
                            <button onclick="cancelPronoEdit()" id="pronoCancelBtn" class="bg-gray-600 px-6 py-3 rounded-lg font-semibold hidden">Annulla</button>
                        </div>
                    </div>
                    
                    <!-- Pronostici Attivi -->
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                            Pronostici Attivi
                        </h3>
                        <div id="adminPronosticiAttivi" class="space-y-3"></div>
                        <p id="noPronosticiAttivi" class="text-gray-500 text-center py-4 hidden">Nessun pronostico attivo</p>
                    </div>
                    
                    <!-- Pronostici Conclusi -->
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <span class="w-3 h-3 bg-gray-500 rounded-full"></span>
                            Pronostici Conclusi
                        </h3>
                        <div id="adminPronosticiConclusi" class="space-y-3"></div>
                        <p id="noPronosticiConclusi" class="text-gray-500 text-center py-4 hidden">Nessun pronostico concluso</p>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="adminUsersTab" class="hidden">
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4">ğŸ‘¥ Membri Registrati</h3>
                        <div id="membersList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>

                <!-- Logo Tab -->
                <div id="adminLogoTab" class="hidden">
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4">ğŸ–¼ï¸ Logo Sito</h3>
                        <div class="flex flex-col items-center gap-4">
                            <img id="logoPreview" src="" class="h-20 hidden">
                            <p id="noLogoText" class="text-gray-400">Nessun logo caricato</p>
                            <div class="flex gap-3">
                                <label class="gradient-bg px-4 py-2 rounded-lg cursor-pointer hover:opacity-90">
                                    ğŸ“¤ Carica Logo
                                    <input type="file" accept="image/*" onchange="uploadLogo(event)" class="hidden">
                                </label>
                                <button onclick="removeLogo()" class="bg-red-600 px-4 py-2 rounded-lg hover:bg-red-700">ğŸ—‘ï¸ Rimuovi</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sponsor Tab -->
                <div id="adminSponsorTab" class="hidden">
                    <div class="bg-gray-800 rounded-xl p-4 md:p-6 mb-6">
                        <h3 class="text-lg font-bold mb-4">â• Aggiungi Sponsor/Partner</h3>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Nome Sponsor</label>
                                <input type="text" id="sponsorName" placeholder="Es. Pizzeria Da Mario" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Link Sito Web (opzionale)</label>
                                <input type="text" id="sponsorLink" placeholder="https://www.esempio.it" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm text-gray-400 mb-2">ğŸ“· Logo/Banner Sponsor</label>
                            <input type="file" id="sponsorImageInput" accept="image/*" class="w-full bg-gray-700 px-4 py-3 rounded-lg border border-gray-600">
                            <div id="sponsorImagePreview" class="mt-2 hidden">
                                <img id="sponsorPreviewImg" src="" class="h-20 object-contain bg-white rounded-lg p-2">
                            </div>
                        </div>
                        <button onclick="addSponsor()" class="mt-4 gradient-bg px-6 py-3 rounded-lg font-semibold">Aggiungi Partner</button>
                    </div>

                    <div class="bg-gray-800 rounded-xl p-4 md:p-6">
                        <h3 class="text-lg font-bold mb-4">ğŸ¤ Partner Attuali</h3>
                        <div id="adminSponsorList" class="space-y-3"></div>
                        <p id="noAdminSponsors" class="text-gray-500 text-center py-4">Nessun partner aggiunto</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Video Modal -->
        <div id="editVideoModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden p-4">
            <div class="bg-gray-800 p-6 rounded-2xl max-w-lg w-full border border-green-600/30">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">âœï¸ Modifica Video</h3>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-white">âœ•</button>
                </div>
                <input type="hidden" id="editVideoId">
                <input type="text" id="editVideoTitle" placeholder="Titolo" class="w-full bg-gray-700 px-4 py-3 rounded-lg mb-3 border border-gray-600">
                <input type="text" id="editVideoUrl" placeholder="URL YouTube" class="w-full bg-gray-700 px-4 py-3 rounded-lg mb-3 border border-gray-600">
                <textarea id="editVideoDesc" placeholder="Descrizione" class="w-full bg-gray-700 px-4 py-3 rounded-lg mb-3 border border-gray-600 h-20"></textarea>
                <select id="editVideoCategory" class="w-full bg-gray-700 px-4 py-3 rounded-lg mb-4 border border-gray-600">
                    <option value="live">ğŸ”´ Live</option>
                    <option value="replays">ğŸ¬ Full Match Replays</option>
                    <option value="highlights">âš¡ Highlights</option>
                    <option value="altro">ğŸ“º Altro</option>
                </select>
                <div class="flex gap-3">
                    <button onclick="saveVideoEdit()" class="flex-1 gradient-bg py-3 rounded-lg font-semibold">ğŸ’¾ Salva</button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-600 py-3 rounded-lg font-semibold">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKknCmCSgWvH-qeP94ppZzFdK2sRSudgQ",
            authDomain: "cestistica-tv-d09dd.firebaseapp.com",
            databaseURL: "https://cestistica-tv-d09dd-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cestistica-tv-d09dd",
            storageBucket: "cestistica-tv-d09dd.firebasestorage.app",
            messagingSenderId: "668272080170",
            appId: "1:668272080170:web:cd3badb4798d26fa26da53"
        };

        // Global State
        let db = null;
        let currentUser = null;
        let currentVideo = null;
        let videosCache = [];
        let usersCache = [];
        let newsCache = [];
        let pronosticiCache = [];
        let heroVideos = [];
        let heroSlideIndex = 0;
        let heroInterval = null;
        let pdfDoc = null;
        let pdfPageNum = 1;
        let deferredPrompt = null;

        // Initialize Firebase
        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                
                db.ref('videos').on('value', (snapshot) => {
                    videosCache = [];
                    snapshot.forEach((child) => {
                        videosCache.push({ id: child.key, ...child.val() });
                    });
                    if (currentUser) {
                        loadVideos();
                        initHeroCarousel();
                        updateAdminStats();
                    }
                });

                db.ref('users').on('value', (snapshot) => {
                    usersCache = [];
                    snapshot.forEach((child) => {
                        usersCache.push({ id: child.key, ...child.val() });
                    });
                    if (currentUser && currentUser.isAdmin) loadMembersList();
                    updateAdminStats();
                });

                db.ref('news').on('value', (snapshot) => {
                    newsCache = [];
                    snapshot.forEach((child) => {
                        newsCache.push({ id: child.key, ...child.val() });
                    });
                    updateAdminStats();
                    if (currentUser && currentUser.isAdmin) loadAdminNewsList();
                });

                db.ref('pronostici').on('value', (snapshot) => {
                    pronosticiCache = [];
                    snapshot.forEach((child) => {
                        pronosticiCache.push({ id: child.key, ...child.val() });
                    });
                    if (currentUser && currentUser.isAdmin) loadAdminPronosticiList();
                });

                db.ref('settings/logo').on('value', (snapshot) => {
                    applyLogo(snapshot.val());
                });

                db.ref('settings/calendar').on('value', (snapshot) => {
                    if (snapshot.val()) {
                        document.getElementById('currentCalendarInfo').classList.remove('hidden');
                    }
                });

                db.ref('.info/connected').on('value', (snapshot) => {
                    updateSyncStatus(snapshot.val() === true);
                });

                document.getElementById('loadingOverlay').style.display = 'none';
                checkAuth();
            } catch (error) {
                console.error('Firebase init error:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                checkAuth();
            }
        }

        function updateSyncStatus(online) {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            indicator.className = online ? 'sync-indicator online' : 'sync-indicator offline';
            text.textContent = online ? 'Sincronizzato' : 'Offline';
        }

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').classList.remove('hidden');
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choice) => {
                    deferredPrompt = null;
                    document.getElementById('installBanner').classList.add('hidden');
                });
            }
        }

        function dismissInstall() {
            document.getElementById('installBanner').classList.add('hidden');
        }

        // Auth Functions
        function checkAuth() {
            const saved = localStorage.getItem('cesticaUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                // Daily login bonus
                const today = new Date().toDateString();
                if (currentUser.lastLogin !== today) {
                    addPoints(3);
                    currentUser.lastLogin = today;
                    db.ref('users/' + currentUser.id).update({ lastLogin: today });
                    localStorage.setItem('cesticaUser', JSON.stringify(currentUser));
                }
                showMainApp();
            } else {
                document.getElementById('authModal').classList.remove('hidden');
            }
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) return showAuthError('Compila tutti i campi');

            const user = usersCache.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                localStorage.setItem('cesticaUser', JSON.stringify(user));
                showMainApp();
            } else {
                showAuthError('Username o password errati');
            }
        }

        function register() {
            const nome = document.getElementById('regNome').value.trim();
            const cognome = document.getElementById('regCognome').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            if (!nome || !cognome || !username || !email || !password) return showAuthError('Compila tutti i campi');
            if (usersCache.find(u => u.username === username)) return showAuthError('Username giÃ  in uso');

            const newUser = { nome, cognome, username, email, password, isAdmin: false, points: 0, date: new Date().toLocaleDateString('it-IT') };
            const newRef = db.ref('users').push();
            newUser.id = newRef.key;
            newRef.set(newUser).then(() => {
                currentUser = newUser;
                localStorage.setItem('cesticaUser', JSON.stringify(newUser));
                showMainApp();
            });
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('cesticaUser');
            location.reload();
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        function showMainApp() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUser.username;
            document.getElementById('headerUserInitial').textContent = currentUser.username.charAt(0).toUpperCase();
            
            // Update header photo
            if (currentUser.profilePhoto) {
                document.getElementById('headerUserPhoto').innerHTML = `<img src="${currentUser.profilePhoto}" class="w-full h-full object-cover">`;
            }
            
            if (currentUser.isAdmin) {
                document.getElementById('adminBtn').classList.remove('hidden');
                document.getElementById('mobileAdminBtn').classList.remove('hidden');
            }
            
            loadVideos();
            initHeroCarousel();
        }

        // Points System
        function addPoints(points) {
            if (!currentUser) return;
            currentUser.points = (currentUser.points || 0) + points;
            db.ref('users/' + currentUser.id).update({ points: currentUser.points });
            localStorage.setItem('cesticaUser', JSON.stringify(currentUser));
        }

        function getBadge(points) {
            if (points >= 1000) return 'ğŸ‘‘ Leggenda';
            if (points >= 500) return 'ğŸ’š Ultras';
            if (points >= 300) return 'ğŸ”¥ Super Tifoso';
            if (points >= 150) return 'ğŸ€ Tifoso';
            if (points >= 50) return 'ğŸ‘€ Spettatore';
            return 'ğŸŒ± Nuovo Arrivato';
        }

        // User Details
        function showUserDetails() {
            const avatarImg = document.getElementById('userAvatarImg');
            const avatarInitial = document.getElementById('userAvatarInitial');
            const removeBtn = document.getElementById('removePhotoBtn');
            
            if (currentUser.profilePhoto) {
                avatarImg.src = currentUser.profilePhoto;
                avatarImg.classList.remove('hidden');
                avatarInitial.classList.add('hidden');
                removeBtn.classList.remove('hidden');
            } else {
                avatarImg.classList.add('hidden');
                avatarInitial.textContent = currentUser.username.charAt(0).toUpperCase();
                avatarInitial.classList.remove('hidden');
                removeBtn.classList.add('hidden');
            }
            
            document.getElementById('userFullName').textContent = `${currentUser.nome} ${currentUser.cognome}`;
            document.getElementById('userUsername').textContent = currentUser.username;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userDate').textContent = currentUser.date;
            document.getElementById('userPoints').textContent = (currentUser.points || 0) + ' ğŸ’š';
            document.getElementById('userBadge').textContent = getBadge(currentUser.points || 0);
            document.getElementById('userDetailsModal').classList.remove('hidden');
        }

        function closeUserDetails() {
            document.getElementById('userDetailsModal').classList.add('hidden');
        }

        function uploadProfilePhoto(event) {
            const file = event.target.files[0];
            if (!file || file.size > 500000) return alert('Immagine troppo grande (max 500KB)');

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const size = Math.min(200, img.width, img.height);
                    canvas.width = size;
                    canvas.height = size;
                    canvas.getContext('2d').drawImage(img, 0, 0, size, size);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    currentUser.profilePhoto = dataUrl;
                    db.ref('users/' + currentUser.id).update({ profilePhoto: dataUrl });
                    localStorage.setItem('cesticaUser', JSON.stringify(currentUser));
                    showUserDetails();
                    
                    // Update header photo
                    document.getElementById('headerUserPhoto').innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePhoto() {
            currentUser.profilePhoto = null;
            db.ref('users/' + currentUser.id).update({ profilePhoto: null });
            localStorage.setItem('cesticaUser', JSON.stringify(currentUser));
            showUserDetails();
            document.getElementById('headerUserPhoto').innerHTML = `<span id="headerUserInitial" class="text-xs font-bold">${currentUser.username.charAt(0).toUpperCase()}</span>`;
        }

        // Biancoverdi Card
        function showBiancoverdiCard() {
            hideAllPages();
            document.getElementById('biancoverdiCardPage').classList.remove('hidden');
            updateCardDisplay();
        }

        function updateCardDisplay() {
            // Logo
            const logo = document.getElementById('cardLogo');
            const emoji = document.getElementById('cardLogoEmoji');
            const headerLogo = document.getElementById('headerLogo');
            if (headerLogo.src && !headerLogo.classList.contains('hidden')) {
                logo.src = headerLogo.src;
                logo.classList.remove('hidden');
                emoji.classList.add('hidden');
            }
            
            // Avatar
            const avatarImg = document.getElementById('cardAvatarImg');
            const avatarInitial = document.getElementById('cardAvatarInitial');
            if (currentUser.profilePhoto) {
                avatarImg.src = currentUser.profilePhoto;
                avatarImg.classList.remove('hidden');
                avatarInitial.classList.add('hidden');
            } else {
                avatarImg.classList.add('hidden');
                avatarInitial.textContent = currentUser.username.charAt(0).toUpperCase();
                avatarInitial.classList.remove('hidden');
            }
            
            document.getElementById('cardFullName').textContent = `${currentUser.nome} ${currentUser.cognome}`;
            document.getElementById('cardUsername').textContent = '@' + currentUser.username;
            document.getElementById('cardNumber').textContent = generateCardNumber(currentUser.id);
            document.getElementById('cardBadge').textContent = getBadge(currentUser.points || 0);
            document.getElementById('cardDate').textContent = currentUser.date;
            
            generateQRCode(currentUser.id);
        }

        function generateCardNumber(id) {
            const hash = id.split('').reduce((a, b) => ((a << 5) - a) + b.charCodeAt(0), 0);
            const num = Math.abs(hash).toString().padStart(6, '0').slice(0, 6);
            return 'BV-' + num + '-2024';
        }

        function generateQRCode(data) {
            const canvas = document.getElementById('qrCanvas');
            const ctx = canvas.getContext('2d');
            const size = 80;
            canvas.width = size;
            canvas.height = size;
            
            // Simple QR-like pattern
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = 'black';
            
            const cellSize = size / 10;
            const hash = data.split('').reduce((a, b) => ((a << 5) - a) + b.charCodeAt(0), 0);
            
            for (let i = 0; i < 10; i++) {
                for (let j = 0; j < 10; j++) {
                    if ((hash >> (i + j)) & 1 || (i < 2 && j < 2) || (i >= 8 && j < 2) || (i < 2 && j >= 8)) {
                        ctx.fillRect(i * cellSize, j * cellSize, cellSize, cellSize);
                    }
                }
            }
        }

        function downloadCard() {
            html2canvas(document.getElementById('cardContainer'), { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'biancoverdi-card.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function addToGoogleWallet() {
            alert('FunzionalitÃ  Google Wallet in arrivo! Per ora puoi scaricare la card come immagine.');
        }

        function addToAppleWallet() {
            alert('FunzionalitÃ  Apple Wallet in arrivo! Per ora puoi scaricare la card come immagine.');
        }

        // Mobile Menu
        function openMobileMenu() {
            document.getElementById('mobileMenu').classList.add('open');
            document.getElementById('mobileMenuOverlay').classList.remove('hidden');
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('open');
            document.getElementById('mobileMenuOverlay').classList.add('hidden');
        }

        // YouTube Helpers
        function extractYouTubeId(url) {
            if (!url) return null;
            const patterns = [
                /youtube\.com\/watch\?v=([^&]+)/,
                /youtu\.be\/([^?]+)/,
                /youtube\.com\/live\/([^?]+)/,
                /youtube\.com\/embed\/([^?]+)/,
                /youtube\.com\/shorts\/([^?]+)/
            ];
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        function extractTimeFromDescription(desc) {
            if (!desc) return null;
            const match = desc.match(/ore\s*(\d{1,2}[:.]\d{2})/i) || desc.match(/(\d{1,2}[:.]\d{2})/);
            return match ? 'ğŸ• ' + match[1].replace('.', ':') : null;
        }

        function extractDateTimeFromDescription(desc) {
            if (!desc) return null;
            
            const numericDateMatch = desc.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
            if (numericDateMatch) {
                const day = numericDateMatch[1].padStart(2, '0');
                const month = numericDateMatch[2].padStart(2, '0');
                const year = numericDateMatch[3];
                return `${day}/${month}/${year}`;
            }
            
            const months = {
                'gennaio': '01', 'febbraio': '02', 'marzo': '03', 'aprile': '04',
                'maggio': '05', 'giugno': '06', 'luglio': '07', 'agosto': '08',
                'settembre': '09', 'ottobre': '10', 'novembre': '11', 'dicembre': '12'
            };
            const textDateMatch = desc.match(/(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)(?:\s+(\d{4}))?/i);
            if (textDateMatch) {
                const day = textDateMatch[1].padStart(2, '0');
                const month = months[textDateMatch[2].toLowerCase()];
                const year = textDateMatch[3] || new Date().getFullYear();
                return `${day}/${month}/${year}`;
            }
            
            return null;
        }

        // Hero Carousel
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function initHeroCarousel() {
            if (videosCache.length === 0) return;
            heroVideos = shuffleArray(videosCache).slice(0, 5);
            heroSlideIndex = 0;
            
            document.getElementById('carouselIndicators').innerHTML = heroVideos.map((_, i) => 
                `<button onclick="goToHeroSlide(${i})" class="w-3 h-3 rounded-full ${i === 0 ? 'bg-green-500 w-8' : 'bg-white/50'} transition-all"></button>`
            ).join('');
            
            updateHeroSlide();
            if (heroInterval) clearInterval(heroInterval);
            heroInterval = setInterval(() => {
                heroSlideIndex = (heroSlideIndex + 1) % heroVideos.length;
                updateHeroSlide();
            }, 6000);
        }

        function updateHeroSlide() {
            if (heroVideos.length === 0) return;
            const video = heroVideos[heroSlideIndex];
            const videoId = extractYouTubeId(video.url);
            const thumb = video.thumbnail || (videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : '');
            
            const bg = document.getElementById('heroBackground');
            bg.style.opacity = '0';
            setTimeout(() => {
                bg.style.backgroundImage = `url('${thumb}')`;
                bg.style.opacity = '1';
            }, 300);
            
            const badge = document.getElementById('heroBadge');
            if (video.category === 'live') {
                badge.textContent = 'ğŸ”´ LIVE';
                badge.className = 'bg-red-600 px-3 py-1 rounded-full text-sm font-medium mb-4 inline-block animate-pulse';
            } else {
                const labels = { replays: 'ğŸ¬ Full Match', highlights: 'âš¡ Highlights', altro: 'ğŸ“º Altro' };
                badge.textContent = labels[video.category] || 'ğŸ€ Cestistica';
                badge.className = 'bg-green-600 px-3 py-1 rounded-full text-sm font-medium mb-4 inline-block';
            }
            
            document.getElementById('heroTitle').textContent = video.title;
            document.getElementById('heroDesc').textContent = video.description || '';
            
            document.querySelectorAll('#carouselIndicators button').forEach((btn, i) => {
                btn.className = `rounded-full transition-all ${i === heroSlideIndex ? 'bg-green-500 w-8 h-3' : 'bg-white/50 w-3 h-3'}`;
            });
        }

        function nextHeroSlide() { heroSlideIndex = (heroSlideIndex + 1) % heroVideos.length; updateHeroSlide(); }
        function prevHeroSlide() { heroSlideIndex = (heroSlideIndex - 1 + heroVideos.length) % heroVideos.length; updateHeroSlide(); }
        function goToHeroSlide(i) { heroSlideIndex = i; updateHeroSlide(); }
        function playHeroVideo() { if (heroVideos.length > 0) playVideo(heroVideos[heroSlideIndex].id); }
        function addHeroToWatchlist() { if (heroVideos.length > 0) toggleWatchlist(heroVideos[heroSlideIndex].id); }

        // Videos
        function loadVideos() {
            ['live', 'replays', 'highlights', 'altro'].forEach(category => {
                const container = document.getElementById(category + 'Videos');
                const videos = videosCache.filter(v => v.category === category);
                container.innerHTML = videos.length === 0 ? '<p class="text-gray-500 py-4">Nessun video</p>' : videos.map(v => createVideoCard(v)).join('');
            });
            if (currentUser?.isAdmin) loadAdminVideoList();
        }

        function createVideoCard(video) {
            const videoId = extractYouTubeId(video.url);
            const thumb = video.thumbnail || (videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : 'https://via.placeholder.com/320x180?text=Video');
            const isInWatchlist = getWatchlist().includes(video.id);
            const views = video.views || 0;
            const likes = video.likes || 0;
            
            let badge = '';
            if (video.category === 'live') {
                const dateTime = extractDateTimeFromDescription(video.description);
                badge = dateTime 
                    ? `<span class="absolute top-2 left-2 bg-green-600/90 text-white text-xs px-2 py-1 rounded font-medium">${dateTime}</span>`
                    : '<span class="absolute top-2 left-2 bg-red-600 text-white text-xs px-2 py-1 rounded font-medium animate-pulse">LIVE</span>';
            }

            const timeInfo = video.category === 'live' ? extractTimeFromDescription(video.description) : null;
            const infoText = timeInfo || `${views} views â€¢ ${likes} â¤ï¸`;

            return `
                <div class="video-card min-w-[200px] md:min-w-[280px] bg-gray-800 rounded-xl overflow-hidden cursor-pointer flex-shrink-0" onclick="playVideo('${video.id}')">
                    <div class="relative group">
                        <img src="${thumb}" alt="${video.title}" class="w-full h-28 md:h-40 object-cover" onerror="this.src='https://via.placeholder.com/320x180?text=Video'">
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <div class="w-12 h-12 bg-white/90 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-gray-900 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            </div>
                        </div>
                        ${badge}
                        <button onclick="event.stopPropagation(); toggleWatchlist('${video.id}')" class="absolute top-2 right-2 w-8 h-8 rounded-full ${isInWatchlist ? 'bg-red-500 text-white' : 'bg-black/50 text-white'} flex items-center justify-center hover:scale-110 transition">
                            <svg class="w-4 h-4" fill="${isInWatchlist ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                        </button>
                    </div>
                    <div class="p-4">
                        <h4 class="font-semibold truncate">${video.title}</h4>
                        <p class="text-sm text-gray-400 mt-1">${infoText}</p>
                    </div>
                </div>
            `;
        }

        function playVideo(id) {
            const video = videosCache.find(v => v.id === id);
            if (!video) {
                console.error('Video non trovato:', id);
                return;
            }
            
            currentVideo = video;
            const videoId = extractYouTubeId(video.url);
            
            console.log('Playing video:', video.title);
            console.log('URL originale:', video.url);
            console.log('Video ID estratto:', videoId);
            
            // Prima nascondi tutte le pagine e mostra la pagina video
            hideAllPages();
            document.getElementById('videoPage').classList.remove('hidden');
            window.scrollTo(0, 0);
            
            // Poi imposta il video player
            const player = document.getElementById('videoPlayer');
            if (!player) {
                console.error('Player non trovato!');
                return;
            }
            
            if (videoId) {
                const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&playsinline=1`;
                console.log('Embed URL:', embedUrl);
                
                // Forza il reload dell'iframe
                player.src = '';
                setTimeout(() => {
                    player.src = embedUrl;
                }, 100);
            } else {
                console.error('Video ID non trovato per URL:', video.url);
                alert('Errore: impossibile caricare il video. URL non valido.');
                return;
            }
            
            document.getElementById('videoTitle').textContent = video.title;
            document.getElementById('videoCategory').textContent = getCategoryLabel(video.category);
            document.getElementById('videoDate').textContent = video.date || '';
            document.getElementById('videoViews').textContent = (video.views || 0) + ' visualizzazioni';
            document.getElementById('videoDescription').textContent = video.description || '';
            
            // Update likes
            const likes = video.likes || 0;
            const userLiked = video.likedBy && video.likedBy.includes(currentUser.id);
            document.getElementById('likeCount').textContent = likes;
            document.getElementById('likeIcon').setAttribute('fill', userLiked ? 'currentColor' : 'none');
            
            // Show live chat for live videos
            const liveChatSection = document.getElementById('liveChatSection');
            if (video.category === 'live') {
                liveChatSection.classList.remove('hidden');
                loadLiveChat();
            } else {
                liveChatSection.classList.add('hidden');
            }
            
            // Increment views
            const newViews = (video.views || 0) + 1;
            db.ref('videos/' + video.id).update({ views: newViews });
            addPoints(5);
            
            loadComments();
            loadRelatedVideos(video.category, video.id);
        }

        function getCategoryLabel(cat) {
            const labels = { live: 'ğŸ”´ Live', replays: 'ğŸ¬ Full Match Replays', highlights: 'âš¡ Highlights', altro: 'ğŸ“º Altro' };
            return labels[cat] || cat;
        }

        function loadRelatedVideos(category, currentId) {
            const related = videosCache.filter(v => v.category === category && v.id !== currentId).slice(0, 5);
            document.getElementById('relatedVideos').innerHTML = related.length === 0 ? '<p class="text-gray-500">Nessun video correlato</p>' : related.map(v => {
                const videoId = extractYouTubeId(v.url);
                const thumb = v.thumbnail || (videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : '');
                return `<div class="flex gap-3 cursor-pointer hover:bg-gray-800 rounded-lg p-2 transition" onclick="playVideo('${v.id}')">
                    <img src="${thumb}" class="w-32 h-20 object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/128x80?text=Video'">
                    <div class="flex-1 min-w-0"><h4 class="font-medium text-sm line-clamp-2">${v.title}</h4></div>
                </div>`;
            }).join('');
        }

        // Like System
        function toggleLike() {
            if (!currentVideo) return;
            
            let likedBy = currentVideo.likedBy || [];
            let likes = currentVideo.likes || 0;
            
            if (likedBy.includes(currentUser.id)) {
                likedBy = likedBy.filter(id => id !== currentUser.id);
                likes--;
            } else {
                likedBy.push(currentUser.id);
                likes++;
                addPoints(2);
            }
            
            db.ref('videos/' + currentVideo.id).update({ likes, likedBy });
            currentVideo.likes = likes;
            currentVideo.likedBy = likedBy;
            
            document.getElementById('likeCount').textContent = likes;
            document.getElementById('likeIcon').setAttribute('fill', likedBy.includes(currentUser.id) ? 'currentColor' : 'none');
        }

        // Share
        function openShareModal() {
            document.getElementById('shareModal').classList.remove('hidden');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        function shareWhatsApp() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(currentVideo.title + ' - Cestistica TV');
            window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
            closeShareModal();
        }

        function shareFacebook() {
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
            closeShareModal();
        }

        function shareTwitter() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(currentVideo.title + ' - Cestistica TV');
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
            closeShareModal();
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href);
            alert('Link copiato!');
            closeShareModal();
        }

        // Live Chat
        let liveChatListener = null;
        
        function loadLiveChat() {
            if (!currentVideo) {
                console.log('loadLiveChat: nessun video corrente');
                return;
            }
            
            console.log('loadLiveChat: caricamento chat per video', currentVideo.id);
            
            // Rimuovi listener precedente se esiste
            if (liveChatListener && liveChatListener !== currentVideo.id) {
                console.log('Rimuovo listener precedente:', liveChatListener);
                db.ref('liveChats/' + liveChatListener).off();
            }
            
            liveChatListener = currentVideo.id;
            
            const container = document.getElementById('liveChatMessages');
            if (!container) {
                console.log('Container chat non trovato!');
                return;
            }
            
            // Mostra messaggio di caricamento
            container.innerHTML = '<p class="text-gray-500 text-center text-sm">Caricamento chat...</p>';
            
            db.ref('liveChats/' + currentVideo.id).orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                console.log('Chat snapshot ricevuto:', snapshot.exists());
                
                const messages = [];
                snapshot.forEach(child => messages.push({ id: child.key, ...child.val() }));
                
                console.log('Messaggi trovati:', messages.length);
                
                if (messages.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center text-sm">Nessun messaggio. Sii il primo a scrivere!</p>';
                } else {
                    container.innerHTML = messages.map(m => `
                        <div class="flex gap-2 text-sm">
                            <span class="font-bold text-green-400">${m.username}:</span>
                            <span class="text-gray-300">${m.text}</span>
                        </div>
                    `).join('');
                }
                container.scrollTop = container.scrollHeight;
            }, (error) => {
                console.error('Errore caricamento chat:', error);
                container.innerHTML = '<p class="text-red-400 text-center text-sm">Errore caricamento chat</p>';
            });
        }

        function sendLiveChat() {
            const input = document.getElementById('liveChatInput');
            if (!input) {
                console.log('Input chat non trovato');
                return;
            }
            
            const text = input.value.trim();
            if (!text) {
                console.log('Nessun testo da inviare');
                return;
            }
            
            if (!currentVideo) {
                console.log('Nessun video corrente');
                return;
            }
            
            console.log('Invio messaggio chat:', text);
            
            db.ref('liveChats/' + currentVideo.id).push({
                username: currentUser.username,
                text,
                timestamp: Date.now()
            }).then(() => {
                console.log('Messaggio inviato con successo');
                addPoints(2);
                input.value = '';
            }).catch((error) => {
                console.error('Errore invio messaggio:', error);
                alert('Errore invio messaggio');
            });
        }

        // Comments
        function loadComments() {
            const container = document.getElementById('commentsList');
            const comments = currentVideo.comments || [];
            container.innerHTML = comments.length === 0 ? '<p class="text-gray-500 text-center py-4">Nessun commento</p>' : comments.map(c => {
                const user = usersCache.find(u => u.username === c.username);
                const photo = user?.profilePhoto;
                return `<div class="flex gap-3">
                    <div class="w-10 h-10 bg-green-600 rounded-full flex-shrink-0 flex items-center justify-center overflow-hidden">
                        ${photo ? `<img src="${photo}" class="w-full h-full object-cover">` : `<span class="font-bold">${c.username.charAt(0).toUpperCase()}</span>`}
                    </div>
                    <div class="flex-1"><div class="flex items-center gap-2"><span class="font-semibold">${c.username}</span><span class="text-xs text-gray-500">${c.date}</span></div><p class="text-gray-300 mt-1">${c.text}</p></div>
                </div>`;
            }).join('');
        }

        function addComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if (!text) return;

            if (!currentVideo.comments) currentVideo.comments = [];
            currentVideo.comments.push({ username: currentUser.username, text, date: new Date().toLocaleDateString('it-IT') });
            db.ref('videos/' + currentVideo.id).update({ comments: currentVideo.comments });
            addPoints(10);
            input.value = '';
            loadComments();
        }

        // Watchlist
        function getWatchlist() { return JSON.parse(localStorage.getItem('cesticaWatchlist_' + currentUser.username) || '[]'); }
        function toggleWatchlist(videoId) {
            let watchlist = getWatchlist();
            if (watchlist.includes(videoId)) watchlist = watchlist.filter(id => id !== videoId);
            else watchlist.push(videoId);
            localStorage.setItem('cesticaWatchlist_' + currentUser.username, JSON.stringify(watchlist));
            loadVideos();
        }

        function showWatchlist() {
            const watchlist = getWatchlist();
            const videos = videosCache.filter(v => watchlist.includes(v.id));
            hideAllPages();
            document.getElementById('watchlistPage').classList.remove('hidden');
            const container = document.getElementById('watchlistVideos');
            const emptyMsg = document.getElementById('emptyWatchlist');
            if (videos.length === 0) { container.innerHTML = ''; emptyMsg.classList.remove('hidden'); }
            else { emptyMsg.classList.add('hidden'); container.innerHTML = videos.map(v => createVideoCard(v)).join(''); }
        }

        // News
        function showNews() {
            hideAllPages();
            document.getElementById('newsPage').classList.remove('hidden');
            loadNewsList();
        }

        function loadNewsList() {
            const container = document.getElementById('newsList');
            const emptyMsg = document.getElementById('emptyNews');
            if (newsCache.length === 0) {
                container.innerHTML = '';
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                container.innerHTML = newsCache.map(n => `
                    <div class="bg-gray-800 rounded-xl overflow-hidden cursor-pointer hover:scale-[1.02] transition" onclick="showNewsArticle('${n.id}')">
                        ${n.image ? `<img src="${n.image}" class="w-full h-48 object-cover">` : '<div class="w-full h-48 bg-gradient-to-br from-green-600 to-green-800 flex items-center justify-center text-6xl">ğŸ“°</div>'}
                        <div class="p-4">
                            <h3 class="font-bold text-lg">${n.title}</h3>
                            <p class="text-gray-400 text-sm mt-2">${n.date}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function showNewsArticle(id) {
            const news = newsCache.find(n => n.id === id);
            if (!news) return;
            
            hideAllPages();
            document.getElementById('newsArticlePage').classList.remove('hidden');
            
            // Video YouTube o video caricato
            let videoEmbed = '';
            if (news.video) {
                const videoId = extractYouTubeId(news.video);
                if (videoId) {
                    videoEmbed = `<div class="aspect-video my-6"><iframe src="https://www.youtube.com/embed/${videoId}" class="w-full h-full rounded-xl" frameborder="0" allowfullscreen></iframe></div>`;
                }
            } else if (news.videoFile) {
                videoEmbed = `
                    <div class="my-6">
                        <video src="${news.videoFile}" class="w-full rounded-xl" controls></video>
                    </div>
                `;
            }
            
            // Galleria immagini
            let imagesGallery = '';
            const images = news.images || (news.image ? [news.image] : []);
            if (images.length > 0) {
                if (images.length === 1) {
                    imagesGallery = `<img src="${images[0]}" class="w-full h-64 md:h-96 object-cover rounded-xl mb-6">`;
                } else {
                    imagesGallery = `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 mb-6">
                            ${images.map((img, i) => `<img src="${img}" class="w-full ${i === 0 ? 'col-span-2 md:col-span-2 h-64' : 'h-32'} object-cover rounded-xl cursor-pointer hover:opacity-80 transition" onclick="window.open('${img}', '_blank')">`).join('')}
                        </div>
                    `;
                }
            }
            
            document.getElementById('articleContent').innerHTML = `
                ${imagesGallery}
                <h1 class="text-3xl md:text-4xl font-bold mb-4">${news.title}</h1>
                <p class="text-gray-400 mb-6">${news.date}</p>
                ${videoEmbed}
                <div class="prose prose-invert max-w-none text-gray-300 leading-relaxed">${news.content.replace(/\n/g, '<br>')}</div>
            `;
        }

        // Calendar
        function showCalendar() {
            hideAllPages();
            document.getElementById('calendarPage').classList.remove('hidden');
            loadCalendar();
        }

        function loadCalendar() {
            db.ref('settings/calendar').once('value', (snapshot) => {
                const calendarData = snapshot.val();
                if (calendarData) {
                    document.getElementById('noCalendar').classList.add('hidden');
                    document.getElementById('calendarPdfViewer').classList.remove('hidden');
                    renderPdf(calendarData);
                }
            });
        }

        function renderPdf(base64Data) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            const pdfData = atob(base64Data.split(',')[1]);
            pdfjsLib.getDocument({ data: pdfData }).promise.then(pdf => {
                pdfDoc = pdf;
                document.getElementById('pdfPageInfo').textContent = `Pagina 1 di ${pdf.numPages}`;
                renderPdfPage(1);
            });
        }

        function renderPdfPage(num) {
            pdfDoc.getPage(num).then(page => {
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                page.render({ canvasContext: ctx, viewport });
                pdfPageNum = num;
                document.getElementById('pdfPageInfo').textContent = `Pagina ${num} di ${pdfDoc.numPages}`;
            });
        }

        function prevPdfPage() { if (pdfPageNum > 1) renderPdfPage(pdfPageNum - 1); }
        function nextPdfPage() { if (pdfDoc && pdfPageNum < pdfDoc.numPages) renderPdfPage(pdfPageNum + 1); }

        // Pronostici
        function showPronostici() {
            hideAllPages();
            document.getElementById('pronosticiPage').classList.remove('hidden');
            loadPronosticiList();
        }

        function loadPronosticiList() {
            const container = document.getElementById('pronosticiList');
            const emptyMsg = document.getElementById('emptyPronostici');
            const activePronostici = pronosticiCache.filter(p => !p.result);
            
            if (activePronostici.length === 0) {
                container.innerHTML = '';
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');
                container.innerHTML = activePronostici.map(p => {
                    const userVote = p.votes ? p.votes[currentUser.id] : null;
                    const votes1 = p.votes ? Object.values(p.votes).filter(v => v === 1).length : 0;
                    const votes2 = p.votes ? Object.values(p.votes).filter(v => v === 2).length : 0;
                    
                    return `
                        <div class="bg-gray-800 rounded-xl p-6">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-sm text-gray-400">${p.date} ${p.time}</span>
                                <span class="text-xs bg-green-600 px-2 py-1 rounded">+5 punti</span>
                            </div>
                            <div class="grid grid-cols-3 gap-4 items-center">
                                <button onclick="votePronostico('${p.id}', 1)" class="p-4 rounded-xl text-center transition ${userVote === 1 ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                    <p class="font-bold">${p.team1}</p>
                                    <p class="text-sm text-gray-400 mt-1">${votes1} voti</p>
                                </button>
                                <div class="text-center text-2xl font-bold text-gray-500">VS</div>
                                <button onclick="votePronostico('${p.id}', 2)" class="p-4 rounded-xl text-center transition ${userVote === 2 ? 'bg-green-600' : 'bg-gray-700 hover:bg-gray-600'}">
                                    <p class="font-bold">${p.team2}</p>
                                    <p class="text-sm text-gray-400 mt-1">${votes2} voti</p>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function votePronostico(id, team) {
            const prono = pronosticiCache.find(p => p.id === id);
            if (!prono || (prono.votes && prono.votes[currentUser.id])) return;
            
            const votes = prono.votes || {};
            votes[currentUser.id] = team;
            db.ref('pronostici/' + id).update({ votes });
            addPoints(5);
            loadPronosticiList();
        }

        // Classifica
        function showClassifica() {
            hideAllPages();
            document.getElementById('classificaPage').classList.remove('hidden');
            loadClassifica();
        }

        function loadClassifica() {
            const sorted = [...usersCache].filter(u => !u.isAdmin).sort((a, b) => (b.points || 0) - (a.points || 0));
            const container = document.getElementById('classificaList');
            container.innerHTML = sorted.map((u, i) => {
                const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i + 1}Â°`;
                return `
                    <div class="flex items-center gap-4 bg-gray-800 rounded-xl p-4 ${i < 3 ? 'border border-yellow-500/30' : ''}">
                        <span class="text-2xl w-10 text-center">${medal}</span>
                        <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center overflow-hidden">
                            ${u.profilePhoto ? `<img src="${u.profilePhoto}" class="w-full h-full object-cover">` : `<span class="font-bold text-lg">${u.username.charAt(0).toUpperCase()}</span>`}
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold">${u.nome} ${u.cognome}</p>
                            <p class="text-sm text-gray-400">${getBadge(u.points || 0)}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-green-400">${u.points || 0}</p>
                            <p class="text-xs text-gray-500">punti</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showPointsInfo() {
            document.getElementById('pointsInfoModal').classList.remove('hidden');
        }

        function closePointsInfo() {
            document.getElementById('pointsInfoModal').classList.add('hidden');
        }

        // Navigation
        // Social Wall
        function showSocialWall() {
            hideAllPages();
            document.getElementById('socialWallPage').classList.remove('hidden');
        }

        function hideAllPages() {
            ['homeContent', 'videoPage', 'watchlistPage', 'adminPage', 'newsPage', 'newsArticlePage', 'calendarPage', 'pronosticiPage', 'classificaPage', 'biancoverdiCardPage', 'socialWallPage'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const player = document.getElementById('videoPlayer');
            if (player) player.src = '';
        }

        function showHome() {
            hideAllPages();
            document.getElementById('homeContent').classList.remove('hidden');
            loadVideos();
        }

        // Search
        function searchVideos() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!query) { loadVideos(); return; }
            
            const filtered = videosCache.filter(v => v.title.toLowerCase().includes(query) || (v.description && v.description.toLowerCase().includes(query)));
            ['live', 'replays', 'highlights', 'altro'].forEach(category => {
                const container = document.getElementById(category + 'Videos');
                const videos = filtered.filter(v => v.category === category);
                container.innerHTML = videos.length === 0 ? '<p class="text-gray-500 py-4">Nessun risultato</p>' : videos.map(v => createVideoCard(v)).join('');
            });
        }

        // Admin
        function showAdmin() {
            if (!currentUser.isAdmin) return;
            hideAllPages();
            document.getElementById('adminPage').classList.remove('hidden');
            showAdminTab('video');
            loadAdminVideoList();
            loadAdminNewsList();
            loadAdminPronosticiList();
            loadMembersList();
            updateAdminStats();
        }

        function showAdminTab(tab) {
            ['video', 'news', 'calendar', 'pronostici', 'users', 'logo', 'sponsor'].forEach(t => {
                document.getElementById('admin' + t.charAt(0).toUpperCase() + t.slice(1) + 'Tab').classList.add('hidden');
                document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.remove('active');
            });
            document.getElementById('admin' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.remove('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }

        function updateAdminStats() {
            document.getElementById('statVideos').textContent = videosCache.length;
            document.getElementById('statUsers').textContent = usersCache.filter(u => !u.isAdmin).length;
            document.getElementById('statViews').textContent = videosCache.reduce((sum, v) => sum + (v.views || 0), 0);
            document.getElementById('statNews').textContent = newsCache.length;
        }

        function addVideo() {
            const title = document.getElementById('newVideoTitle').value.trim();
            const url = document.getElementById('newVideoUrl').value.trim();
            const category = document.getElementById('newVideoCategory').value;
            const description = document.getElementById('newVideoDesc').value.trim();
            const thumbnail = document.getElementById('newVideoThumbnail').value.trim();

            if (!title || !url) return alert('Inserisci titolo e URL');

            const videoId = extractYouTubeId(url);
            const newVideo = { 
                title, url, category, description, 
                thumbnail: thumbnail || (videoId ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg` : ''), 
                date: new Date().toLocaleDateString('it-IT'), 
                views: 0, likes: 0, comments: [] 
            };
            db.ref('videos').push().set(newVideo);
            ['newVideoTitle', 'newVideoUrl', 'newVideoDesc', 'newVideoThumbnail'].forEach(id => document.getElementById(id).value = '');
        }

        function loadAdminVideoList() {
            const container = document.getElementById('adminVideoList');
            container.innerHTML = videosCache.length === 0 ? '<p class="text-gray-500">Nessun video</p>' : videosCache.map(v => `
                <div class="flex flex-col md:flex-row md:items-center gap-3 bg-gray-700 rounded-lg p-3">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <img src="${v.thumbnail || ''}" class="w-20 h-12 object-cover rounded" onerror="this.src='https://via.placeholder.com/80x48?text=Video'">
                        <div class="min-w-0"><p class="font-medium truncate">${v.title}</p><p class="text-sm text-gray-400">${getCategoryLabel(v.category)} â€¢ ${v.views || 0} views</p></div>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="openEditModal('${v.id}')" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-700 text-sm">âœï¸</button>
                        <button onclick="deleteVideo('${v.id}')" class="bg-red-600 px-3 py-1 rounded hover:bg-red-700 text-sm">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }

        function openEditModal(id) {
            const video = videosCache.find(v => v.id === id);
            if (!video) return;
            document.getElementById('editVideoId').value = video.id;
            document.getElementById('editVideoTitle').value = video.title;
            document.getElementById('editVideoUrl').value = video.url;
            document.getElementById('editVideoDesc').value = video.description || '';
            document.getElementById('editVideoCategory').value = video.category;
            document.getElementById('editVideoModal').classList.remove('hidden');
        }

        function closeEditModal() { document.getElementById('editVideoModal').classList.add('hidden'); }

        function saveVideoEdit() {
            const id = document.getElementById('editVideoId').value;
            const updates = {
                title: document.getElementById('editVideoTitle').value.trim(),
                url: document.getElementById('editVideoUrl').value.trim(),
                description: document.getElementById('editVideoDesc').value.trim(),
                category: document.getElementById('editVideoCategory').value
            };
            db.ref('videos/' + id).update(updates).then(() => closeEditModal());
        }

        function deleteVideo(id) {
            if (!confirm('Eliminare questo video?')) return;
            db.ref('videos/' + id).remove();
        }

        // News Admin
        let newsImages = [];
        let newsVideoFile = null;
        let editingNewsId = null;
        
        // Event listener per upload video news
        document.addEventListener('DOMContentLoaded', function() {
            const videoInput = document.getElementById('newsVideoInput');
            if (videoInput) {
                videoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Max 10MB
                    if (file.size > 10 * 1024 * 1024) {
                        alert('Video troppo grande! Max 10MB. Per video piÃ¹ lunghi usa YouTube.');
                        e.target.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        newsVideoFile = event.target.result;
                        const preview = document.getElementById('newsVideoPreview');
                        const player = document.getElementById('newsVideoPreviewPlayer');
                        player.src = newsVideoFile;
                        preview.classList.remove('hidden');
                        // Svuota il campo YouTube se si carica un file
                        document.getElementById('newNewsVideo').value = '';
                    };
                    reader.readAsDataURL(file);
                });
            }
        });
        
        function removeNewsVideo() {
            newsVideoFile = null;
            document.getElementById('newsVideoInput').value = '';
            document.getElementById('newsVideoPreview').classList.add('hidden');
            document.getElementById('newsVideoPreviewPlayer').src = '';
        }
        
        document.getElementById('newsImagesInput')?.addEventListener('change', function(e) {
            const files = Array.from(e.target.files).slice(0, 5);
            newsImages = [];
            const preview = document.getElementById('newsImagesPreview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                if (file.size > 1000000) {
                    alert('Immagine troppo grande (max 1MB per immagine)');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Comprimi l'immagine
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const maxSize = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = (height / width) * maxSize;
                                width = maxSize;
                            } else {
                                width = (width / height) * maxSize;
                                height = maxSize;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        newsImages.push(dataUrl);
                        
                        // Mostra preview
                        preview.innerHTML += `<img src="${dataUrl}" class="w-16 h-16 object-cover rounded">`;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        });
        
        function addNews() {
            const title = document.getElementById('newNewsTitle').value.trim();
            const content = document.getElementById('newNewsContent').value.trim();
            const youtubeVideo = document.getElementById('newNewsVideo').value.trim();
            
            if (!title || !content) return alert('Inserisci titolo e contenuto');
            
            const newsData = {
                title, content,
                video: youtubeVideo,
                videoFile: newsVideoFile || null,
                images: newsImages,
                image: newsImages[0] || '',
                date: new Date().toLocaleDateString('it-IT')
            };
            
            if (editingNewsId) {
                db.ref('news/' + editingNewsId).update(newsData);
                cancelNewsEdit();
            } else {
                db.ref('news').push().set(newsData);
            }
            
            // Reset form
            document.getElementById('newNewsTitle').value = '';
            document.getElementById('newNewsContent').value = '';
            document.getElementById('newNewsVideo').value = '';
            document.getElementById('newsImagesInput').value = '';
            document.getElementById('newsImagesPreview').innerHTML = '';
            document.getElementById('newsVideoInput').value = '';
            document.getElementById('newsVideoPreview').classList.add('hidden');
            newsImages = [];
            newsVideoFile = null;
            
            loadAdminNewsList();
        }
        
        function loadAdminNewsList() {
            const container = document.getElementById('adminNewsList');
            if (!container) return;
            
            if (newsCache.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Nessuna news</p>';
                return;
            }
            
            container.innerHTML = newsCache.map(n => `
                <div class="flex flex-col md:flex-row md:items-center gap-3 bg-gray-700 rounded-lg p-3">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        ${n.image ? `<img src="${n.image}" class="w-16 h-12 object-cover rounded">` : '<div class="w-16 h-12 bg-green-600 rounded flex items-center justify-center">ğŸ“°</div>'}
                        <div class="min-w-0">
                            <p class="font-medium truncate">${n.title}</p>
                            <p class="text-sm text-gray-400">${n.date}</p>
                        </div>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button onclick="editNews('${n.id}')" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-700 text-sm">âœï¸</button>
                        <button onclick="deleteNews('${n.id}')" class="bg-red-600 px-3 py-1 rounded hover:bg-red-700 text-sm">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }
        
        function editNews(id) {
            const news = newsCache.find(n => n.id === id);
            if (!news) return;
            
            editingNewsId = id;
            document.getElementById('editNewsId').value = id;
            document.getElementById('newNewsTitle').value = news.title;
            document.getElementById('newNewsContent').value = news.content;
            document.getElementById('newNewsVideo').value = news.video || '';
            
            // Mostra immagini esistenti
            newsImages = news.images || (news.image ? [news.image] : []);
            const preview = document.getElementById('newsImagesPreview');
            preview.innerHTML = newsImages.map(img => `<img src="${img}" class="w-16 h-16 object-cover rounded">`).join('');
            
            // Mostra video caricato esistente
            if (news.videoFile) {
                newsVideoFile = news.videoFile;
                const videoPreview = document.getElementById('newsVideoPreview');
                const videoPlayer = document.getElementById('newsVideoPreviewPlayer');
                videoPlayer.src = news.videoFile;
                videoPreview.classList.remove('hidden');
            } else {
                newsVideoFile = null;
                document.getElementById('newsVideoPreview').classList.add('hidden');
            }
            
            document.getElementById('newsFormTitle').textContent = 'âœï¸ Modifica News';
            document.getElementById('newsSubmitBtn').textContent = 'Salva Modifiche';
            document.getElementById('newsCancelBtn').classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('adminNewsTab').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelNewsEdit() {
            editingNewsId = null;
            document.getElementById('editNewsId').value = '';
            document.getElementById('newNewsTitle').value = '';
            document.getElementById('newNewsContent').value = '';
            document.getElementById('newNewsVideo').value = '';
            document.getElementById('newsImagesInput').value = '';
            document.getElementById('newsImagesPreview').innerHTML = '';
            document.getElementById('newsVideoInput').value = '';
            document.getElementById('newsVideoPreview').classList.add('hidden');
            document.getElementById('newsVideoPreviewPlayer').src = '';
            newsImages = [];
            newsVideoFile = null;
            
            document.getElementById('newsFormTitle').textContent = 'â• Nuova News';
            document.getElementById('newsSubmitBtn').textContent = 'Pubblica News';
            document.getElementById('newsCancelBtn').classList.add('hidden');
        }
        
        function deleteNews(id) {
            if (!confirm('Eliminare questa news?')) return;
            db.ref('news/' + id).remove();
        }

        // Calendar Admin
        function uploadCalendarPdf(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') return alert('Seleziona un file PDF');
            if (file.size > 5000000) return alert('File troppo grande (max 5MB)');
            
            const reader = new FileReader();
            reader.onload = e => {
                db.ref('settings/calendar').set(e.target.result);
                document.getElementById('currentCalendarInfo').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function removeCalendar() {
            db.ref('settings/calendar').remove();
            document.getElementById('currentCalendarInfo').classList.add('hidden');
            document.getElementById('noCalendar').classList.remove('hidden');
            document.getElementById('calendarPdfViewer').classList.add('hidden');
        }

        // Pronostici Admin
        let editingPronoId = null;
        
        function addPronostico() {
            const team1 = document.getElementById('newPronoTeam1').value.trim();
            const team2 = document.getElementById('newPronoTeam2').value.trim();
            const date = document.getElementById('newPronoDate').value;
            const time = document.getElementById('newPronoTime').value;
            
            if (!team1 || !team2 || !date || !time) return alert('Compila tutti i campi');
            
            const pronoData = { team1, team2, date, time, votes: {}, result: null };
            
            if (editingPronoId) {
                db.ref('pronostici/' + editingPronoId).update({ team1, team2, date, time });
                cancelPronoEdit();
            } else {
                db.ref('pronostici').push().set(pronoData);
            }
            
            ['newPronoTeam1', 'newPronoTeam2', 'newPronoDate', 'newPronoTime'].forEach(id => document.getElementById(id).value = '');
            loadAdminPronosticiList();
        }
        
        function loadAdminPronosticiList() {
            const attiviContainer = document.getElementById('adminPronosticiAttivi');
            const conclusiContainer = document.getElementById('adminPronosticiConclusi');
            const noAttivi = document.getElementById('noPronosticiAttivi');
            const noConclusi = document.getElementById('noPronosticiConclusi');
            
            if (!attiviContainer || !conclusiContainer) return;
            
            const attivi = pronosticiCache.filter(p => !p.result);
            const conclusi = pronosticiCache.filter(p => p.result);
            
            // Pronostici Attivi
            if (attivi.length === 0) {
                attiviContainer.innerHTML = '';
                noAttivi.classList.remove('hidden');
            } else {
                noAttivi.classList.add('hidden');
                attiviContainer.innerHTML = attivi.map(p => {
                    const votes1 = p.votes ? Object.values(p.votes).filter(v => v === 1).length : 0;
                    const votes2 = p.votes ? Object.values(p.votes).filter(v => v === 2).length : 0;
                    const totalVotes = votes1 + votes2;
                    
                    return `
                        <div class="bg-gray-700 rounded-xl p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <p class="text-sm text-gray-400">ğŸ“… ${p.date} â€¢ ğŸ• ${p.time}</p>
                                    <p class="text-xs text-green-400 mt-1">ğŸ‘¥ ${totalVotes} voti totali</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editPronostico('${p.id}')" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-700 text-sm" title="Modifica">âœï¸</button>
                                    <button onclick="deletePronostico('${p.id}')" class="bg-red-600 px-3 py-1 rounded hover:bg-red-700 text-sm" title="Elimina">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 items-center mb-4">
                                <div class="text-center">
                                    <p class="font-bold">${p.team1}</p>
                                    <p class="text-sm text-green-400">${votes1} voti</p>
                                </div>
                                <div class="text-center text-2xl font-bold text-gray-500">VS</div>
                                <div class="text-center">
                                    <p class="font-bold">${p.team2}</p>
                                    <p class="text-sm text-green-400">${votes2} voti</p>
                                </div>
                            </div>
                            
                            <div class="border-t border-gray-600 pt-3">
                                <p class="text-sm text-gray-400 mb-2">ğŸ† Segna risultato finale:</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="setPronoResult('${p.id}', 1, '${p.team1}')" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-sm font-medium transition">
                                        âœ… Vince ${p.team1}
                                    </button>
                                    <button onclick="setPronoResult('${p.id}', 2, '${p.team2}')" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-sm font-medium transition">
                                        âœ… Vince ${p.team2}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Pronostici Conclusi
            if (conclusi.length === 0) {
                conclusiContainer.innerHTML = '';
                noConclusi.classList.remove('hidden');
            } else {
                noConclusi.classList.add('hidden');
                conclusiContainer.innerHTML = conclusi.map(p => {
                    const votes1 = p.votes ? Object.values(p.votes).filter(v => v === 1).length : 0;
                    const votes2 = p.votes ? Object.values(p.votes).filter(v => v === 2).length : 0;
                    const winnerName = p.result === 1 ? p.team1 : p.team2;
                    
                    return `
                        <div class="bg-gray-700/50 rounded-xl p-4 border border-gray-600">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="text-sm text-gray-400">ğŸ“… ${p.date}</p>
                                </div>
                                <span class="bg-gray-600 text-xs px-2 py-1 rounded">Concluso</span>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 items-center mb-2">
                                <div class="text-center ${p.result === 1 ? 'text-green-400' : 'text-gray-400'}">
                                    <p class="font-bold">${p.team1} ${p.result === 1 ? 'ğŸ†' : ''}</p>
                                    <p class="text-sm">${votes1} voti</p>
                                </div>
                                <div class="text-center text-xl font-bold text-gray-500">VS</div>
                                <div class="text-center ${p.result === 2 ? 'text-green-400' : 'text-gray-400'}">
                                    <p class="font-bold">${p.team2} ${p.result === 2 ? 'ğŸ†' : ''}</p>
                                    <p class="text-sm">${votes2} voti</p>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-600">
                                <p class="text-sm text-green-400">ğŸ† Vincitore: <strong>${winnerName}</strong></p>
                                <button onclick="deletePronostico('${p.id}')" class="text-red-400 hover:text-red-300 text-sm">ğŸ—‘ï¸ Elimina</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function editPronostico(id) {
            const prono = pronosticiCache.find(p => p.id === id);
            if (!prono) return;
            
            editingPronoId = id;
            document.getElementById('editPronoId').value = id;
            document.getElementById('newPronoTeam1').value = prono.team1;
            document.getElementById('newPronoTeam2').value = prono.team2;
            document.getElementById('newPronoDate').value = prono.date;
            document.getElementById('newPronoTime').value = prono.time;
            
            document.getElementById('pronoFormTitle').textContent = 'âœï¸ Modifica Pronostico';
            document.getElementById('pronoSubmitBtn').textContent = 'Salva Modifiche';
            document.getElementById('pronoCancelBtn').classList.remove('hidden');
            
            // Scroll al form
            document.getElementById('adminPronosticiTab').scrollIntoView({ behavior: 'smooth' });
        }
        
        function cancelPronoEdit() {
            editingPronoId = null;
            document.getElementById('editPronoId').value = '';
            ['newPronoTeam1', 'newPronoTeam2', 'newPronoDate', 'newPronoTime'].forEach(id => document.getElementById(id).value = '');
            
            document.getElementById('pronoFormTitle').textContent = 'â• Nuovo Pronostico';
            document.getElementById('pronoSubmitBtn').textContent = 'Crea Pronostico';
            document.getElementById('pronoCancelBtn').classList.add('hidden');
        }
        
        function deletePronostico(id) {
            if (!confirm('Eliminare questo pronostico?')) return;
            db.ref('pronostici/' + id).remove();
        }
        
        function setPronoResult(id, winner, winnerName) {
            if (!confirm(`Confermi che ha vinto ${winnerName}? Verranno assegnati +50 punti a chi ha indovinato.`)) return;
            
            const prono = pronosticiCache.find(p => p.id === id);
            if (!prono) return;
            
            // Assegna punti a chi ha indovinato
            if (prono.votes) {
                Object.entries(prono.votes).forEach(([odieId, vote]) => {
                    if (vote === winner) {
                        // Trova l'utente e aggiungi punti
                        const user = usersCache.find(u => u.id === odieId);
                        if (user) {
                            const newPoints = (user.points || 0) + 50;
                            db.ref('users/' + odieId).update({ points: newPoints });
                        }
                    }
                });
            }
            
            // Segna il risultato
            db.ref('pronostici/' + id).update({ result: winner });
            alert(`Risultato registrato! +50 punti assegnati a chi ha votato ${winnerName}.`);
        }

        function loadMembersList() {
            const container = document.getElementById('membersList');
            const members = usersCache.filter(u => !u.isAdmin);
            container.innerHTML = members.length === 0 ? '<p class="text-gray-500">Nessun membro</p>' : members.map(u => `
                <div class="flex items-center gap-3 bg-gray-700 rounded-lg p-3">
                    <div class="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center overflow-hidden">
                        ${u.profilePhoto ? `<img src="${u.profilePhoto}" class="w-full h-full object-cover">` : `<span class="font-bold">${u.username.charAt(0).toUpperCase()}</span>`}
                    </div>
                    <div class="flex-1 min-w-0"><p class="font-medium">${u.nome} ${u.cognome}</p><p class="text-sm text-gray-400">${u.email}</p></div>
                    <div class="text-right">
                        <span class="text-green-400 font-bold">${u.points || 0} ğŸ’š</span>
                        <p class="text-xs text-gray-500">${u.date}</p>
                    </div>
                </div>
            `).join('');
        }

        // Logo
        function applyLogo(logo) {
            const headerLogo = document.getElementById('headerLogo');
            const headerEmoji = document.getElementById('headerLogoEmoji');
            const authLogo = document.getElementById('authLogo');
            const authPlaceholder = document.getElementById('authLogoPlaceholder');
            const preview = document.getElementById('logoPreview');
            const noLogoText = document.getElementById('noLogoText');

            if (logo) {
                headerLogo.src = logo; headerLogo.classList.remove('hidden'); headerEmoji.classList.add('hidden');
                authLogo.src = logo; authLogo.classList.remove('hidden'); authPlaceholder.classList.add('hidden');
                if (preview) { preview.src = logo; preview.classList.remove('hidden'); noLogoText?.classList.add('hidden'); }
            } else {
                headerLogo.classList.add('hidden'); headerEmoji.classList.remove('hidden');
                authLogo.classList.add('hidden'); authPlaceholder.classList.remove('hidden');
                if (preview) { preview.classList.add('hidden'); noLogoText?.classList.remove('hidden'); }
            }
        }

        function uploadLogo(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => db.ref('settings/logo').set(e.target.result);
            reader.readAsDataURL(file);
        }

        function removeLogo() { db.ref('settings/logo').remove(); }

        // Sponsor Functions
        let sponsorsCache = [];

        function loadSponsors() {
            db.ref('sponsors').on('value', (snapshot) => {
                sponsorsCache = [];
                snapshot.forEach((child) => {
                    sponsorsCache.push({ id: child.key, ...child.val() });
                });
                renderSponsors();
                if (currentUser && currentUser.isAdmin) loadAdminSponsorList();
            });
        }

        function renderSponsors() {
            const container = document.getElementById('sponsorList');
            const noSponsors = document.getElementById('noSponsors');
            
            if (!container) return;
            
            if (sponsorsCache.length === 0) {
                container.innerHTML = '';
                if (noSponsors) noSponsors.classList.remove('hidden');
                document.getElementById('sponsorSection')?.classList.add('hidden');
            } else {
                if (noSponsors) noSponsors.classList.add('hidden');
                document.getElementById('sponsorSection')?.classList.remove('hidden');
                container.innerHTML = sponsorsCache.map(s => `
                    <a href="${s.link || '#'}" target="${s.link ? '_blank' : '_self'}" class="block hover:scale-105 transition group ${s.link ? '' : 'pointer-events-none'}">
                        <div class="aspect-video bg-white rounded-xl overflow-hidden shadow-lg group-hover:shadow-2xl transition">
                            <img src="${s.image}" alt="${s.name}" title="${s.name}" class="w-full h-full object-contain p-4">
                        </div>
                        <p class="text-center mt-2 text-gray-400 text-sm font-medium">${s.name}</p>
                    </a>
                `).join('');
            }
        }

        function loadAdminSponsorList() {
            const container = document.getElementById('adminSponsorList');
            const noSponsors = document.getElementById('noAdminSponsors');
            
            if (!container) return;
            
            if (sponsorsCache.length === 0) {
                container.innerHTML = '';
                if (noSponsors) noSponsors.classList.remove('hidden');
            } else {
                if (noSponsors) noSponsors.classList.add('hidden');
                container.innerHTML = sponsorsCache.map(s => `
                    <div class="flex items-center gap-4 bg-gray-700 rounded-lg p-3">
                        <img src="${s.image}" alt="${s.name}" class="h-12 w-20 object-contain bg-white rounded p-1">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium truncate">${s.name}</p>
                            <p class="text-sm text-gray-400 truncate">${s.link || 'Nessun link'}</p>
                        </div>
                        <button onclick="deleteSponsor('${s.id}')" class="bg-red-600 px-3 py-1 rounded hover:bg-red-700 text-sm">ğŸ—‘ï¸</button>
                    </div>
                `).join('');
            }
        }

        function addSponsor() {
            const name = document.getElementById('sponsorName').value.trim();
            const link = document.getElementById('sponsorLink').value.trim();
            const fileInput = document.getElementById('sponsorImageInput');
            
            if (!name) return alert('Inserisci il nome dello sponsor');
            if (!fileInput.files[0]) return alert('Carica il logo dello sponsor');
            
            const file = fileInput.files[0];
            if (file.size > 1000000) return alert('Immagine troppo grande (max 1MB)');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxSize = 400;
                    let width = img.width;
                    let height = img.height;
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/png', 0.9);
                    
                    db.ref('sponsors').push().set({
                        name,
                        link: link || null,
                        image: dataUrl,
                        date: new Date().toLocaleDateString('it-IT')
                    }).then(() => {
                        document.getElementById('sponsorName').value = '';
                        document.getElementById('sponsorLink').value = '';
                        document.getElementById('sponsorImageInput').value = '';
                        document.getElementById('sponsorImagePreview').classList.add('hidden');
                        alert('Partner aggiunto con successo!');
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function deleteSponsor(id) {
            if (!confirm('Eliminare questo partner?')) return;
            db.ref('sponsors/' + id).remove();
        }

        // Preview sponsor image
        document.getElementById('sponsorImageInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('sponsorPreviewImg').src = event.target.result;
                    document.getElementById('sponsorImagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Initialize
        initFirebase();
        loadSponsors();
    </script>
</body>
</html>
